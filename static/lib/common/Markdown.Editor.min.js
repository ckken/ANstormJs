/*
 "name": "pagedown", modified by jsGen
 "version": "1.1.0",
 "repository": { "type": "hg", "url": "https://code.google.com/p/pagedown/" },
 "keywords": ["markdown"],
 "license": "MIT",
 "homepage": "http://code.google.com/p/pagedown/wiki/PageDown"
 */
(function (u) {
    function C(a) {
        return a
    }

    function F() {
        return!1
    }

    function D() {
    }

    function z() {
    }

    function G(a) {
        this.buttonBar = e.getElementById("wmd-button-bar" + a);
        this.preview = e.getElementById("wmd-preview" + a);
        this.input = e.getElementById("wmd-input" + a)
    }

    function H(a, b) {
        var c = this, d = [], f = 0, k = "none", j, h, g, n = function (a, b) {
            k != a && (k = a, b || e());
            !v.isIE || "moving" != k ? h = setTimeout(r, 1) : g = null
        }, r = function (a) {
            g = new A(b, a);
            h = void 0
        };
        this.setCommandMode = function () {
            k = "command";
            e();
            h = setTimeout(r, 0)
        };
        this.canUndo = function () {
            return 1 <
                f
        };
        this.canRedo = function () {
            return d[f + 1] ? !0 : !1
        };
        this.undo = function () {
            c.canUndo() && (j ? (j.restore(), j = null) : (d[f] = new A(b), d[--f].restore(), a && a()));
            k = "none";
            b.input.focus();
            r()
        };
        this.redo = function () {
            c.canRedo() && (d[++f].restore(), a && a());
            k = "none";
            b.input.focus();
            r()
        };
        var e = function () {
            var c = g || new A(b);
            if (!c)return!1;
            "moving" == k ? j || (j = c) : (j && (d[f - 1].text != j.text && (d[f++] = j), j = null), d[f++] = c, d[f + 1] = null, a && a())
        };
        p.addEvent(b.input, "keypress", function (a) {
            (a.ctrlKey || a.metaKey) && (!a.altKey && (89 == a.keyCode ||
                90 == a.keyCode)) && a.preventDefault()
        });
        var l = function () {
            if ((v.isIE || g && g.text != b.input.value) && void 0 == h)k = "paste", e(), r()
        };
        p.addEvent(b.input, "keydown", function (a) {
            var b = !1;
            if ((a.ctrlKey || a.metaKey) && !a.altKey)switch (String.fromCharCode(a.charCode || a.keyCode).toLowerCase()) {
                case "y":
                    c.redo();
                    b = !0;
                    break;
                case "z":
                    a.shiftKey ? c.redo() : c.undo(), b = !0
            }
            b && (a.preventDefault && a.preventDefault(), u.event && (u.event.returnValue = !1))
        });
        p.addEvent(b.input, "keydown", function (a) {
            !a.ctrlKey && !a.metaKey && (a = a.keyCode,
                33 <= a && 40 >= a || 63232 <= a && 63235 >= a ? n("moving") : 8 == a || 46 == a || 127 == a ? n("deleting") : 13 == a ? n("newlines") : 27 == a ? n("escape") : (16 > a || 20 < a) && 91 != a && n("typing"))
        });
        p.addEvent(b.input, "mousedown", function () {
            n("moving")
        });
        b.input.onpaste = l;
        b.input.ondrop = l;
        r(!0);
        e()
    }

    function A(a, b) {
        var c = this, d = a.input;
        this.init = function () {
            if (p.isVisible(d) && (b || !(e.activeElement && e.activeElement !== d)))if (this.setInputAreaSelectionStartEnd(), this.scrollTop = d.scrollTop, !this.text && d.selectionStart || 0 === d.selectionStart)this.text =
                d.value
        };
        this.setInputAreaSelection = function () {
            if (p.isVisible(d))if (void 0 !== d.selectionStart && !v.isOpera)d.focus(), d.selectionStart = c.start, d.selectionEnd = c.end, d.scrollTop = c.scrollTop; else if (e.selection && !(e.activeElement && e.activeElement !== d)) {
                d.focus();
                var a = d.createTextRange();
                a.moveStart("character", -d.value.length);
                a.moveEnd("character", -d.value.length);
                a.moveEnd("character", c.end);
                a.moveStart("character", c.start);
                a.select()
            }
        };
        this.setInputAreaSelectionStartEnd = function () {
            if (!a.ieCachedRange &&
                (d.selectionStart || 0 === d.selectionStart))c.start = d.selectionStart, c.end = d.selectionEnd; else if (e.selection) {
                c.text = p.fixEolChars(d.value);
                var b = a.ieCachedRange || e.selection.createRange(), k = p.fixEolChars(b.text), j = "\u0007" + k + "\u0007";
                b.text = j;
                var h = p.fixEolChars(d.value);
                b.moveStart("character", -j.length);
                b.text = k;
                c.start = h.indexOf("\u0007");
                c.end = h.lastIndexOf("\u0007") - 1;
                if (j = c.text.length - p.fixEolChars(d.value).length) {
                    for (b.moveStart("character", -k.length); j--;)k += "\n", c.end += 1;
                    b.text = k
                }
                a.ieCachedRange &&
                (c.scrollTop = a.ieCachedScrollTop);
                a.ieCachedRange = null;
                this.setInputAreaSelection()
            }
        };
        this.restore = function () {
            void 0 != c.text && c.text != d.value && (d.value = c.text);
            this.setInputAreaSelection();
            d.scrollTop = c.scrollTop
        };
        this.getChunks = function () {
            var a = new z;
            a.before = p.fixEolChars(c.text.substring(0, c.start));
            a.startTag = "";
            a.selection = p.fixEolChars(c.text.substring(c.start, c.end));
            a.endTag = "";
            a.after = p.fixEolChars(c.text.substring(c.end));
            a.scrollTop = c.scrollTop;
            return a
        };
        this.setChunks = function (a) {
            a.before +=
                a.startTag;
            a.after = a.endTag + a.after;
            this.start = a.before.length;
            this.end = a.before.length + a.selection.length;
            this.text = a.before + a.selection + a.after;
            this.scrollTop = a.scrollTop
        };
        this.init()
    }

    function I(a, b, c) {
        var d, f, k, j = function () {
            var a = 0;
            u.innerHeight ? a = u.pageYOffset : e.documentElement && e.documentElement.scrollTop ? a = e.documentElement.scrollTop : e.body && (a = e.body.scrollTop);
            return a
        }, h = function () {
            if (b.preview) {
                var d = b.input.value;
                if (!(d && d == k)) {
                    k = d;
                    var g = (new Date).getTime(), d = a.makeHtml(d);
                    f = (new Date).getTime() -
                        g;
                    var h = t.getTop(b.input) - j();
                    if (b.preview) {
                        if (l)l(d); else try {
                            w(d), l = w
                        } catch (L) {
                            l = r, l(d)
                        }
                        c()
                    }
                    if (b.preview) {
                        var d = b.preview, g = b.preview.scrollHeight - b.preview.clientHeight, e;
                        e = b.preview;
                        e = e.scrollHeight <= e.clientHeight ? 1 : e.scrollTop / (e.scrollHeight - e.clientHeight);
                        d.scrollTop = g * e
                    }
                    if (n)n = !1; else {
                        var m = t.getTop(b.input) - j();
                        v.isIE ? setTimeout(function () {
                            u.scrollBy(0, m - h)
                        }, 0) : u.scrollBy(0, m - h)
                    }
                }
            }
        }, g = function () {
            d && (clearTimeout(d), d = void 0);
            var a = 0, a = f;
            3E3 < a && (a = 3E3);
            d = setTimeout(h, a)
        };
        this.refresh = function (a) {
            a ?
                (k = "", h()) : g()
        };
        this.processingTime = function () {
            return f
        };
        var n = !0, r = function (a) {
            var c = b.preview, d = c.parentNode, g = c.nextSibling;
            d.removeChild(c);
            c.innerHTML = a;
            g ? d.insertBefore(c, g) : d.appendChild(c)
        }, w = function (a) {
            b.preview.innerHTML = a
        }, l, m = b.input;
        p.addEvent(m, "input", g);
        m.onpaste = g;
        m.ondrop = g;
        p.addEvent(m, "keypress", g);
        p.addEvent(m, "keydown", g);
        h();
        b.preview && (b.preview.scrollTop = 0)
    }

    function J(a, b, c, d, f, k, j) {
        function h(a) {
            w.focus();
            if (a.textOp) {
                c && c.setCommandMode();
                var g = new A(b);
                if (!g)return;
                var f =
                    g.getChunks(), h = function () {
                    w.focus();
                    f && g.setChunks(f);
                    g.restore();
                    d.refresh()
                };
                a.textOp(f, h) || h()
            }
            a.execute && a.execute(c)
        }

        function g(a, c) {
            var d = a.getElementsByTagName("span")[0];
            c ? (d.style.backgroundPosition = a.XShift + " 0px", a.onmouseover = function () {
                d.style.backgroundPosition = this.XShift + " -40px"
            }, a.onmouseout = function () {
                d.style.backgroundPosition = this.XShift + " 0px"
            }, v.isIE && (a.onmousedown = function () {
                e.activeElement && e.activeElement !== b.input || (b.ieCachedRange = document.selection.createRange(), b.ieCachedScrollTop =
                    b.input.scrollTop)
            }), a.isHelp || (a.onclick = function () {
                if (this.onmouseout)this.onmouseout();
                h(this);
                return!1
            })) : (d.style.backgroundPosition = a.XShift + " -20px", a.onmouseover = a.onmouseout = a.onclick = function () {
            })
        }

        function n(a) {
            "string" === typeof a && (a = f[a]);
            return function () {
                a.apply(f, arguments)
            }
        }

        function r() {
            c && (g(l.undo, c.canUndo()), g(l.redo, c.canRedo()))
        }

        var w = b.input, l = {}, m = b.buttonBar, q = document.createElement("ul");
        q.id = "wmd-button-row" + a;
        q.className = "wmd-button-row";
        var q = m.appendChild(q), s = 0, m = function (b, c, d, f) {
            var h = document.createElement("li");
            h.className = "wmd-button";
            h.style.left = s + "px";
            s += 25;
            var j = document.createElement("span");
            h.id = b + a;
            h.appendChild(j);
            h.title = c;
            h.XShift = d;
            f && (h.textOp = f);
            g(h, !0);
            q.appendChild(h);
            return h
        }, t = function (b) {
            var c = document.createElement("li");
            c.className = "wmd-spacer wmd-spacer" + b;
            c.id = "wmd-spacer" + b + a;
            q.appendChild(c);
            s += 25
        };
        l.bold = m("wmd-bold-button", j("bold"), "0px", n("doBold"));
        l.italic = m("wmd-italic-button", j("italic"), "-20px", n("doItalic"));
        t(1);
        l.link = m("wmd-link-button",
            j("link"), "-40px", n(function (a, b) {
                return this.doLinkOrImage(a, b, !1)
            }));
        l.quote = m("wmd-quote-button", j("quote"), "-60px", n("doBlockquote"));
        l.code = m("wmd-code-button", j("code"), "-80px", n("doCode"));
        l.image = m("wmd-image-button", j("image"), "-100px", n(function (a, b) {
            return this.doLinkOrImage(a, b, !0)
        }));
        t(2);
        l.olist = m("wmd-olist-button", j("olist"), "-120px", n(function (a, b) {
            this.doList(a, b, !0)
        }));
        l.ulist = m("wmd-ulist-button", j("ulist"), "-140px", n(function (a, b) {
            this.doList(a, b, !1)
        }));
        l.heading = m("wmd-heading-button",
            j("heading"), "-160px", n("doHeading"));
        l.hr = m("wmd-hr-button", j("hr"), "-180px", n("doHorizontalRule"));
        t(3);
        l.undo = m("wmd-undo-button", j("undo"), "-200px", null);
        l.undo.execute = function (a) {
            a && a.undo()
        };
        t = /win/.test(x.platform.toLowerCase()) ? j("redo") : j("redomac");
        l.redo = m("wmd-redo-button", t, "-220px", null);
        l.redo.execute = function (a) {
            a && a.redo()
        };
        k && (m = document.createElement("li"), t = document.createElement("span"), m.appendChild(t), m.className = "wmd-button wmd-help-button", m.id = "wmd-help-button" + a, m.XShift =
            "-240px", m.isHelp = !0, m.style.right = "0px", m.title = j("help"), m.onclick = k.handler, g(m, !0), q.appendChild(m), l.help = m);
        r();
        k = "keydown";
        v.isOpera && (k = "keypress");
        p.addEvent(w, k, function (a) {
            if ((a.ctrlKey || a.metaKey) && !a.altKey && !a.shiftKey) {
                switch (String.fromCharCode(a.charCode || a.keyCode).toLowerCase()) {
                    case "b":
                        h(l.bold);
                        break;
                    case "i":
                        h(l.italic);
                        break;
                    case "l":
                        h(l.link);
                        break;
                    case "q":
                        h(l.quote);
                        break;
                    case "k":
                        h(l.code);
                        break;
                    case "g":
                        h(l.image);
                        break;
                    case "o":
                        h(l.olist);
                        break;
                    case "u":
                        h(l.ulist);
                        break;
                    case "h":
                        h(l.heading);
                        break;
                    case "r":
                        h(l.hr);
                        break;
                    case "y":
                        h(l.redo);
                        break;
                    case "z":
                        a.shiftKey ? h(l.redo) : h(l.undo);
                        break;
                    default:
                        return
                }
                a.preventDefault && a.preventDefault();
                u.event && (u.event.returnValue = !1)
            }
        });
        p.addEvent(w, "keyup", function (a) {
            if (a.shiftKey && (!a.ctrlKey && !a.metaKey) && 13 === (a.charCode || a.keyCode))a = {}, a.textOp = n("doAutoindent"), h(a)
        });
        v.isIE && p.addEvent(w, "keydown", function (a) {
            if (27 === a.keyCode)return!1
        });
        this.setUndoRedoButtonStates = r
    }

    function E(a, b) {
        this.hooks = a;
        this.getString = b
    }

    var B = {};
    D.prototype = {chain: function (a, b) {
        var c = this[a];
        if (!c)throw Error("unknown hook " + a);
        this[a] = c === C ? b : function (a) {
            var f = Array.prototype.slice.call(arguments, 0);
            f[0] = c.apply(null, f);
            return b.apply(null, f)
        }
    }, set: function (a, b) {
        if (!this[a])throw Error("unknown hook " + a);
        this[a] = b
    }, addNoop: function (a) {
        this[a] = C
    }, addFalse: function (a) {
        this[a] = F
    }};
    B.HookCollection = D;
    var p = {}, t = {}, y = {}, e = u.document, q = u.RegExp, x = u.navigator, v = {isIE: /msie/.test(x.userAgent.toLowerCase()), isIE_5or6: /msie 6/.test(x.userAgent.toLowerCase()) ||
        /msie 5/.test(x.userAgent.toLowerCase()), isOpera: /opera/.test(x.userAgent.toLowerCase())}, K = {bold: "Strong <strong> Ctrl+B", boldexample: "strong text", italic: "Emphasis <em> Ctrl+I", italicexample: "emphasized text", link: "Hyperlink <a> Ctrl+L", linkdescription: "enter link description here", linkdialog: '<p><b>Insert Hyperlink</b></p><p>http://example.com/ "optional title"</p>', quote: "Blockquote <blockquote> Ctrl+Q", quoteexample: "Blockquote", code: "Code Sample <pre><code> Ctrl+K", codeexample: "enter code here",
        image: "Image <img> Ctrl+G", imagedescription: "enter image description here", imagedialog: "<p><b>Insert Image</b></p><p>http://example.com/images/diagram.jpg \"optional title\"<br><br>Need <a href='http://www.google.com/search?q=free+image+hosting' target='_blank'>free image hosting?</a></p>", olist: "Numbered List <ol> Ctrl+O", ulist: "Bulleted List <ul> Ctrl+U", litem: "List item", heading: "Heading <h1>/<h2> Ctrl+H", headingexample: "Heading", hr: "Horizontal Rule <hr> Ctrl+R", undo: "Undo - Ctrl+Z", redo: "Redo - Ctrl+Y",
        redomac: "Redo - Ctrl+Shift+Z", help: "Markdown Editing Help"};
    B.Editor = function (a, b, c) {
        c = c || {};
        "function" === typeof c.handler && (c = {helpButton: c});
        c.strings = c.strings || {};
        c.helpButton && (c.strings.help = c.strings.help || c.helpButton.title);
        var d = function (a) {
            return c.strings[a] || K[a]
        };
        b = b || "";
        var f = this.hooks = new B.HookCollection;
        f.addNoop("onPreviewRefresh");
        f.addNoop("postBlockquoteCreation");
        f.addFalse("insertImageDialog");
        this.getConverter = function () {
            return a
        };
        var k = this, j;
        this.run = function () {
            if (!j) {
                j =
                    new G(b);
                var h = new E(f, d), g = new I(a, j, function () {
                    f.onPreviewRefresh()
                }), n, r;
                /\?noundo/.test(e.location.href) || (n = new H(function () {
                    g.refresh();
                    r && r.setUndoRedoButtonStates()
                }, j), this.textOperation = function (a) {
                    n.setCommandMode();
                    a();
                    k.refreshPreview()
                });
                r = new J(b, j, n, g, h, c.helpButton, d);
                r.setUndoRedoButtonStates();
                (k.refreshPreview = function () {
                    g.refresh(!0)
                })()
            }
        }
    };
    z.prototype.findTags = function (a, b) {
        var c = this, d;
        a && (d = p.extendRegExp(a, "", "$"), this.before = this.before.replace(d, function (a) {
            c.startTag +=
                a;
            return""
        }), d = p.extendRegExp(a, "^", ""), this.selection = this.selection.replace(d, function (a) {
            c.startTag += a;
            return""
        }));
        b && (d = p.extendRegExp(b, "", "$"), this.selection = this.selection.replace(d, function (a) {
            c.endTag = a + c.endTag;
            return""
        }), d = p.extendRegExp(b, "^", ""), this.after = this.after.replace(d, function (a) {
            c.endTag = a + c.endTag;
            return""
        }))
    };
    z.prototype.trimWhitespace = function (a) {
        var b, c = this;
        a ? a = b = "" : (a = function (a) {
            c.before += a;
            return""
        }, b = function (a) {
            c.after = a + c.after;
            return""
        });
        this.selection = this.selection.replace(/^(\s*)/,
            a).replace(/(\s*)$/, b)
    };
    z.prototype.skipLines = function (a, b, c) {
        void 0 === a && (a = 1);
        void 0 === b && (b = 1);
        a++;
        b++;
        var d, f;
        navigator.userAgent.match(/Chrome/) && "X".match(/()./);
        this.selection = this.selection.replace(/(^\n*)/, "");
        this.startTag += q.$1;
        this.selection = this.selection.replace(/(\n*$)/, "");
        this.endTag += q.$1;
        this.startTag = this.startTag.replace(/(^\n*)/, "");
        this.before += q.$1;
        this.endTag = this.endTag.replace(/(\n*$)/, "");
        this.after += q.$1;
        if (this.before) {
            for (d = f = ""; a--;)d += "\\n?", f += "\n";
            c && (d = "\\n*");
            this.before = this.before.replace(new q(d + "$", ""), f)
        }
        if (this.after) {
            for (d = f = ""; b--;)d += "\\n?", f += "\n";
            c && (d = "\\n*");
            this.after = this.after.replace(new q(d, ""), f)
        }
    };
    p.isVisible = function (a) {
        if (u.getComputedStyle)return"none" !== u.getComputedStyle(a, null).getPropertyValue("display");
        if (a.currentStyle)return"none" !== a.currentStyle.display
    };
    p.addEvent = function (a, b, c) {
        a.attachEvent ? a.attachEvent("on" + b, c) : a.addEventListener(b, c, !1)
    };
    p.removeEvent = function (a, b, c) {
        a.detachEvent ? a.detachEvent("on" + b, c) : a.removeEventListener(b,
            c, !1)
    };
    p.fixEolChars = function (a) {
        a = a.replace(/\r\n/g, "\n");
        return a = a.replace(/\r/g, "\n")
    };
    p.extendRegExp = function (a, b, c) {
        if (null === b || void 0 === b)b = "";
        if (null === c || void 0 === c)c = "";
        a = a.toString();
        var d;
        a = a.replace(/\/([gim]*)$/, function (a, b) {
            d = b;
            return""
        });
        a = a.replace(/(^\/|\/$)/g, "");
        return new q(b + a + c, d)
    };
    t.getTop = function (a, b) {
        var c = a.offsetTop;
        if (!b)for (; a = a.offsetParent;)c += a.offsetTop;
        return c
    };
    t.getHeight = function (a) {
        return a.offsetHeight || a.scrollHeight
    };
    t.getWidth = function (a) {
        return a.offsetWidth ||
            a.scrollWidth
    };
    t.getPageSize = function () {
        var a, b, c, d;
        self.innerHeight && self.scrollMaxY ? (a = e.body.scrollWidth, b = self.innerHeight + self.scrollMaxY) : e.body.scrollHeight > e.body.offsetHeight ? (a = e.body.scrollWidth, b = e.body.scrollHeight) : (a = e.body.offsetWidth, b = e.body.offsetHeight);
        self.innerHeight ? (c = self.innerWidth, d = self.innerHeight) : e.documentElement && e.documentElement.clientHeight ? (c = e.documentElement.clientWidth, d = e.documentElement.clientHeight) : e.body && (c = e.body.clientWidth, d = e.body.clientHeight);
        a =
            Math.max(a, c);
        b = Math.max(b, d);
        return[a, b, c, d]
    };
    y.createBackground = function () {
        var a = e.createElement("div"), b = a.style;
        a.className = "wmd-prompt-background";
        b.position = "absolute";
        b.top = "0";
        b.zIndex = "1000";
        v.isIE ? b.filter = "alpha(opacity=50)" : b.opacity = "0.5";
        var c = t.getPageSize();
        b.height = c[1] + "px";
        v.isIE ? (b.left = e.documentElement.scrollLeft, b.width = e.documentElement.clientWidth) : (b.left = "0", b.width = "100%");
        e.body.appendChild(a);
        return a
    };
    y.prompt = function (a, b, c) {
        var d, f;
        void 0 === b && (b = "");
        var k = function (a) {
            27 ===
                (a.charCode || a.keyCode) && j(!0)
        }, j = function (a) {
            p.removeEvent(e.body, "keydown", k);
            var b = f.value;
            a ? b = null : (b = b.replace(/^http:\/\/(https?|ftp):\/\//, "$1://"), /^(?:https?|ftp):\/\//.test(b) || (b = "http://" + b));
            d.parentNode.removeChild(d);
            c(b);
            return!1
        };
        setTimeout(function () {
            d = e.createElement("div");
            d.className = "wmd-prompt-dialog";
            d.style.padding = "10px;";
            d.style.position = "fixed";
            d.style.width = "400px";
            d.style.zIndex = "1001";
            var c = e.createElement("div");
            c.innerHTML = a;
            c.style.padding = "5px";
            d.appendChild(c);
            var c = e.createElement("form"), g = c.style;
            c.onsubmit = function () {
                return j(!1)
            };
            g.padding = "0";
            g.margin = "0";
            g.cssFloat = "left";
            g.width = "100%";
            g.textAlign = "center";
            g.position = "relative";
            d.appendChild(c);
            f = e.createElement("input");
            f.type = "text";
            f.value = b;
            g = f.style;
            g.display = "block";
            g.width = "80%";
            g.marginLeft = g.marginRight = "auto";
            c.appendChild(f);
            var n = e.createElement("input");
            n.type = "button";
            n.onclick = function () {
                return j(!1)
            };
            n.value = "OK";
            g = n.style;
            g.margin = "10px";
            g.display = "inline";
            g.width = "7em";
            var r = e.createElement("input");
            r.type = "button";
            r.onclick = function () {
                return j(!0)
            };
            r.value = "Cancel";
            g = r.style;
            g.margin = "10px";
            g.display = "inline";
            g.width = "7em";
            c.appendChild(n);
            c.appendChild(r);
            p.addEvent(e.body, "keydown", k);
            d.style.top = "50%";
            d.style.left = "50%";
            d.style.display = "block";
            v.isIE_5or6 && (d.style.position = "absolute", d.style.top = e.documentElement.scrollTop + 200 + "px", d.style.left = "50%");
            e.body.appendChild(d);
            d.style.marginTop = -(t.getHeight(d) / 2) + "px";
            d.style.marginLeft = -(t.getWidth(d) / 2) + "px";
            c = b.length;
            void 0 !== f.selectionStart ?
                (f.selectionStart = 0, f.selectionEnd = c) : f.createTextRange && (g = f.createTextRange(), g.collapse(!1), g.moveStart("character", -c), g.moveEnd("character", c), g.select());
            f.focus()
        }, 0)
    };
    var s = E.prototype;
    s.prefixes = "(?:\\s{4,}|\\s*>|\\s*-\\s+|\\s*\\d+\\.|=|\\+|-|_|\\*|#|\\s*\\[[^\n]]+\\]:)";
    s.unwrap = function (a) {
        var b = new q("([^\\n])\\n(?!(\\n|" + this.prefixes + "))", "g");
        a.selection = a.selection.replace(b, "$1 $2")
    };
    s.wrap = function (a, b) {
        this.unwrap(a);
        var c = new q("(.{1," + b + "})( +|$\\n?)", "gm"), d = this;
        a.selection =
            a.selection.replace(c, function (a, b) {
                return(new q("^" + d.prefixes, "")).test(a) ? a : b + "\n"
            });
        a.selection = a.selection.replace(/\s+$/, "")
    };
    s.doBold = function (a, b) {
        return this.doBorI(a, b, 2, this.getString("boldexample"))
    };
    s.doItalic = function (a, b) {
        return this.doBorI(a, b, 1, this.getString("italicexample"))
    };
    s.doBorI = function (a, b, c, d) {
        a.trimWhitespace();
        a.selection = a.selection.replace(/\n{2,}/g, "\n");
        var f = /(\**$)/.exec(a.before)[0];
        b = /(^\**)/.exec(a.after)[0];
        f = Math.min(f.length, b.length);
        f >= c && (2 != f || 1 != c) ? (a.before =
            a.before.replace(q("[*]{" + c + "}$", ""), ""), a.after = a.after.replace(q("^[*]{" + c + "}", ""), "")) : !a.selection && b ? (a.after = a.after.replace(/^([*_]*)/, ""), a.before = a.before.replace(/(\s?)$/, ""), a.before = a.before + b + q.$1) : (!a.selection && !b && (a.selection = d), c = 1 >= c ? "*" : "**", a.before += c, a.after = c + a.after)
    };
    s.stripLinkDefs = function (a, b) {
        return a = a.replace(/^[ ]{0,3}\[(\d+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?[ \t]*\n?[ \t]*(?:(\n*)["(](.+?)[")][ \t]*)?(?:\n+|$)/gm, function (a, d, f, e, j) {
            b[d] = a.replace(/\s*$/, "");
            return e ? (b[d] =
                a.replace(/["(](.+?)[")]$/, ""), e + j) : ""
        })
    };
    s.addLinkDef = function (a, b) {
        var c = 0, d = {};
        a.before = this.stripLinkDefs(a.before, d);
        a.selection = this.stripLinkDefs(a.selection, d);
        a.after = this.stripLinkDefs(a.after, d);
        var f = "", e = /(\[)((?:\[[^\]]*\]|[^\[\]])*)(\][ ]?(?:\n[ ]*)?\[)(\d+)(\])/g, j = function (a) {
            c++;
            a = a.replace(/^[ ]{0,3}\[(\d+)\]:/, "  [" + c + "]:");
            f += "\n" + a
        }, h = function (a, b, g, f, m, p) {
            g = g.replace(e, h);
            return d[m] ? (j(d[m]), b + g + f + c + p) : a
        };
        a.before = a.before.replace(e, h);
        b ? j(b) : a.selection = a.selection.replace(e,
            h);
        var g = c;
        a.after = a.after.replace(e, h);
        a.after && (a.after = a.after.replace(/\n*$/, ""));
        a.after || (a.selection = a.selection.replace(/\n*$/, ""));
        a.after += "\n\n" + f;
        return g
    };
    s.doLinkOrImage = function (a, b, c) {
        a.trimWhitespace();
        a.findTags(/\s*!?\[/, /\][ ]?(?:\n[ ]*)?(\[.*?\])?/);
        var d;
        if (1 < a.endTag.length && 0 < a.startTag.length)a.startTag = a.startTag.replace(/!?\[/, ""), a.endTag = "", this.addLinkDef(a, null); else if (a.selection = a.startTag + a.selection + a.endTag, a.startTag = a.endTag = "", /\n\n/.test(a.selection))this.addLinkDef(a,
            null); else {
            var f = this, e = function (e) {
                d.parentNode.removeChild(d);
                null !== e && (a.selection = (" " + a.selection).replace(/([^\\](?:\\\\)*)(?=[[\]])/g, "$1\\").substr(1), e = " [999]: " + e.replace(/^\s*(.*?)(?:\s+"(.+)")?\s*$/, function (a, b, c) {
                    b = b.replace(/\?.*$/, function (a) {
                        return a.replace(/\+/g, " ")
                    });
                    b = decodeURIComponent(b);
                    b = encodeURI(b).replace(/'/g, "%27").replace(/\(/g, "%28").replace(/\)/g, "%29");
                    b = b.replace(/\?.*$/, function (a) {
                        return a.replace(/\+/g, "%2b")
                    });
                    c && (c = c.trim ? c.trim() : c.replace(/^\s*/, "").replace(/\s*$/,
                        ""), c = c.replace(/"/g, "quot;").replace(/\(/g, "&#40;").replace(/\)/g, "&#41;").replace(/</g, "&lt;").replace(/>/g, "&gt;"));
                    return c ? b + ' "' + c + '"' : b
                }), e = f.addLinkDef(a, e), a.startTag = c ? "![" : "[", a.endTag = "][" + e + "]", a.selection || (a.selection = c ? f.getString("imagedescription") : f.getString("linkdescription")));
                b()
            };
            d = y.createBackground();
            c ? this.hooks.insertImageDialog(e) || y.prompt(this.getString("imagedialog"), "http://", e) : y.prompt(this.getString("linkdialog"), "http://", e);
            return!0
        }
    };
    s.doAutoindent = function (a) {
        var b =
            !1;
        a.before = a.before.replace(/(\n|^)[ ]{0,3}([*+-]|\d+[.])[ \t]*\n$/, "\n\n");
        a.before = a.before.replace(/(\n|^)[ ]{0,3}>[ \t]*\n$/, "\n\n");
        a.before = a.before.replace(/(\n|^)[ \t]+\n$/, "\n\n");
        !a.selection && !/^[ \t]*(?:\n|$)/.test(a.after) && (a.after = a.after.replace(/^[^\n]*/, function (b) {
            a.selection = b;
            return""
        }), b = !0);
        /(\n|^)[ ]{0,3}([*+-]|\d+[.])[ \t]+.*\n$/.test(a.before) && this.doList && this.doList(a);
        /(\n|^)[ ]{0,3}>[ \t]+.*\n$/.test(a.before) && this.doBlockquote && this.doBlockquote(a);
        /(\n|^)(\t|[ ]{4,}).*\n$/.test(a.before) &&
            this.doCode && this.doCode(a);
        b && (a.after = a.selection + a.after, a.selection = "")
    };
    s.doBlockquote = function (a) {
        a.selection = a.selection.replace(/^(\n*)([^\r]+?)(\n*)$/, function (b, c, d, e) {
            a.before += c;
            a.after = e + a.after;
            return d
        });
        a.before = a.before.replace(/(>[ \t]*)$/, function (b, c) {
            a.selection = c + a.selection;
            return""
        });
        a.selection = a.selection.replace(/^(\s|>)+$/, "");
        a.selection = a.selection || this.getString("quoteexample");
        var b = "", c = "", d;
        if (a.before) {
            for (var e = a.before.replace(/\n$/, "").split("\n"), k = !1, j = 0; j <
                e.length; j++) {
                var h = !1;
                d = e[j];
                k = k && 0 < d.length;
                /^>/.test(d) ? (h = !0, !k && 1 < d.length && (k = !0)) : h = /^[ \t]*$/.test(d) ? !0 : k;
                h ? b += d + "\n" : (c += b + d, b = "\n")
            }
            /(^|\n)>/.test(b) || (c += b, b = "")
        }
        a.startTag = b;
        a.before = c;
        a.after && (a.after = a.after.replace(/^\n?/, "\n"));
        a.after = a.after.replace(/^(((\n|^)(\n[ \t]*)*>(.+\n)*.*)+(\n[ \t]*)*)/, function (b) {
            a.endTag = b;
            return""
        });
        b = function (b) {
            var c = b ? "> " : "";
            a.startTag && (a.startTag = a.startTag.replace(/\n((>|\s)*)\n$/, function (a, b) {
                return"\n" + b.replace(/^[ ]{0,3}>?[ \t]*$/gm, c) +
                    "\n"
            }));
            a.endTag && (a.endTag = a.endTag.replace(/^\n((>|\s)*)\n/, function (a, b) {
                return"\n" + b.replace(/^[ ]{0,3}>?[ \t]*$/gm, c) + "\n"
            }))
        };
        /^(?![ ]{0,3}>)/m.test(a.selection) ? (this.wrap(a, 70), a.selection = a.selection.replace(/^/gm, "> "), b(!0), a.skipLines()) : (a.selection = a.selection.replace(/^[ ]{0,3}> ?/gm, ""), this.unwrap(a), b(!1), !/^(\n|^)[ ]{0,3}>/.test(a.selection) && a.startTag && (a.startTag = a.startTag.replace(/\n{0,2}$/, "\n\n")), !/(\n|^)[ ]{0,3}>.*$/.test(a.selection) && a.endTag && (a.endTag = a.endTag.replace(/^\n{0,2}/,
            "\n\n")));
        a.selection = this.hooks.postBlockquoteCreation(a.selection);
        /\n/.test(a.selection) || (a.selection = a.selection.replace(/^(> *)/, function (b, c) {
            a.startTag += c;
            return""
        }))
    };
    s.doCode = function (a) {
        var b = /\S[ ]*$/.test(a.before);
        if (!/^[ ]*\S/.test(a.after) && !b || /\n/.test(a.selection)) {
            a.before = a.before.replace(/[ ]{4}$/, function (b) {
                a.selection = b + a.selection;
                return""
            });
            var c = b = 1;
            /(\n|^)(\t|[ ]{4,}).*\n$/.test(a.before) && (b = 0);
            /^\n(\t|[ ]{4,})/.test(a.after) && (c = 0);
            a.skipLines(b, c);
            a.selection ? /^[ ]{0,3}\S/m.test(a.selection) ?
                /\n/.test(a.selection) ? a.selection = a.selection.replace(/^/gm, "    ") : a.before += "    " : a.selection = a.selection.replace(/^(?:[ ]{4}|[ ]{0,3}\t)/gm, "") : (a.startTag = "    ", a.selection = this.getString("codeexample"))
        } else a.trimWhitespace(), a.findTags(/`/, /`/), !a.startTag && !a.endTag ? (a.startTag = a.endTag = "`", a.selection || (a.selection = this.getString("codeexample"))) : a.endTag && !a.startTag ? (a.before += a.endTag, a.endTag = "") : a.startTag = a.endTag = ""
    };
    s.doList = function (a, b, c) {
        b = /^\n*(([ ]{0,3}([*+-]|\d+[.])[ \t]+.*)(\n.+|\n{2,}([*+-].*|\d+[.])[ \t]+.*|\n{2,}[ \t]+\S.*)*)\n*/;
        var d = "-", e = 1, k = function () {
            var a;
            c ? (a = " " + e + ". ", e++) : a = " " + d + " ";
            return a
        }, j = function (a) {
            void 0 === c && (c = /^\s*\d/.test(a));
            return a = a.replace(/^[ ]{0,3}([*+-]|\d+[.])\s/gm, function () {
                return k()
            })
        };
        a.findTags(/(\n|^)*[ ]{0,3}([*+-]|\d+[.])\s+/, null);
        a.before && (!/\n$/.test(a.before) && !/^\n/.test(a.startTag)) && (a.before += a.startTag, a.startTag = "");
        if (a.startTag) {
            var h = /\d+[.]/.test(a.startTag);
            a.startTag = "";
            a.selection = a.selection.replace(/\n[ ]{4}/g, "\n");
            this.unwrap(a);
            a.skipLines();
            h && (a.after = a.after.replace(b,
                j));
            if (c == h)return
        }
        var g = 1;
        a.before = a.before.replace(/(\n|^)(([ ]{0,3}([*+-]|\d+[.])[ \t]+.*)(\n.+|\n{2,}([*+-].*|\d+[.])[ \t]+.*|\n{2,}[ \t]+\S.*)*)\n*$/, function (a) {
            /^\s*([*+-])/.test(a) && (d = q.$1);
            g = /[^\n]\n\n[^\n]/.test(a) ? 1 : 0;
            return j(a)
        });
        a.selection || (a.selection = this.getString("litem"));
        var h = k(), n = 1;
        a.after = a.after.replace(b, function (a) {
            n = /[^\n]\n\n[^\n]/.test(a) ? 1 : 0;
            return j(a)
        });
        a.trimWhitespace(!0);
        a.skipLines(g, n, !0);
        a.startTag = h;
        b = h.replace(/./g, " ");
        this.wrap(a, 72 - b.length);
        a.selection =
            a.selection.replace(/\n/g, "\n" + b)
    };
    s.doHeading = function (a) {
        a.selection = a.selection.replace(/\s+/g, " ");
        a.selection = a.selection.replace(/(^\s+|\s+$)/g, "");
        if (a.selection) {
            var b = 0;
            a.findTags(/#+[ ]*/, /[ ]*#+/);
            /#+/.test(a.startTag) && (b = q.lastMatch.length);
            a.startTag = a.endTag = "";
            a.findTags(null, /\s?(-+|=+)/);
            /=+/.test(a.endTag) && (b = 1);
            /-+/.test(a.endTag) && (b = 2);
            a.startTag = a.endTag = "";
            a.skipLines(1, 1);
            b = 0 == b ? 2 : b - 1;
            if (0 < b) {
                var b = 2 <= b ? "-" : "=", c = a.selection.length;
                72 < c && (c = 72);
                for (a.endTag = "\n"; c--;)a.endTag +=
                    b
            }
        } else a.startTag = "## ", a.selection = this.getString("headingexample"), a.endTag = " ##"
    };
    s.doHorizontalRule = function (a) {
        a.startTag = "----------\n";
        a.selection = "";
        a.skipLines(2, 1, !0)
    };
    u.Markdown = B
})(window);
